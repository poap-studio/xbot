datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Config {
  id              String   @id @default(cuid())
  poapEventId     String   @default("")
  poapEditCode    String   @default("") // Edit code for POAP API to load QR codes

  // Multiple claims configuration
  allowMultipleClaims Boolean  @default(false) // Allow users to claim multiple POAPs for same event

  // Reply messages
  botReplyEligible    String   @default("¡Felicidades! Has compartido el código correcto. Reclama tu POAP aquí: {{claimUrl}}")
  botReplyNotEligible String   @default("Gracias por tu interés. Asegúrate de incluir un código válido y una imagen en tu tweet.")
  botReplyAlreadyClaimed String @default("You have already claimed a POAP for this event. Only one claim per user is allowed.")

  // Search configuration
  twitterHashtag  String   @default("#POAP")

  // QR Page configuration
  qrPageTweetTemplate String @default("I visited the POAP Studio booth at ETH Global, and here's the proof! The secret word is {{code}} {{hashtag}}")

  // QR Page Display customization
  qrPageLogoUrl        String? // e.g., "/qr-page-assets/logo.png"
  qrPageBackgroundUrl  String? // e.g., "/qr-page-assets/background.jpg"
  qrPageCustomText     String? // Custom text overlay on QR code
  qrPagePoapEventId    String? // POAP event ID to fetch artwork

  // POAP API credentials (encrypted)
  poapClientId    String?
  poapClientSecret String?

  // Relación con cuenta del bot
  botAccountId    String?  @unique
  botAccount      BotAccount? @relation(fields: [botAccountId], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("config")
}

model ValidCode {
  id              String   @id @default(cuid())
  code            String   @unique
  isUsed          Boolean  @default(false)
  usedBy          String?  // twitterId
  usedAt          DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([code])
  @@index([isUsed])
  @@map("valid_codes")
}

model BotAccount {
  id              String   @id @default(cuid())
  twitterId       String   @unique
  username        String
  displayName     String?
  profileImageUrl String?

  // OAuth credentials para postear (encrypted)
  accessToken     String
  accessSecret    String

  // Estado de conexión
  isConnected     Boolean  @default(true)
  lastUsedAt      DateTime?
  connectedAt     DateTime @default(now())

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  config          Config?

  @@map("bot_accounts")
}

model TwitterUser {
  id              String   @id @default(cuid())
  twitterId       String   @unique
  username        String
  displayName     String?
  profileImageUrl String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  deliveries      Delivery[]

  @@map("twitter_users")
}

model Delivery {
  id              String   @id @default(cuid())
  twitterUserId   String   // References TwitterUser.id (cuid)
  twitterUser     TwitterUser @relation(fields: [twitterUserId], references: [id])
  tweetId         String   @unique
  mintLink        String
  qrHash          String   @unique
  deliveredAt     DateTime @default(now())
  claimed         Boolean  @default(false)
  claimedAt       DateTime?

  @@index([twitterUserId])
  @@index([claimed])
  @@map("deliveries")
}

model Tweet {
  id              String   @id @default(cuid())
  tweetId         String   @unique
  twitterUserId   String
  username        String
  text            String
  hasImage        Boolean
  hasCode         Boolean
  isEligible      Boolean
  processedAt     DateTime @default(now())
  botReplied      Boolean  @default(false)
  botReplyTweetId String?

  @@index([tweetId])
  @@index([isEligible])
  @@map("tweets")
}

model PoapAuth {
  id              String   @id @default(cuid())
  accessToken     String   @db.Text // OAuth2 bearer token
  expiresAt       DateTime // Token expires after 24h
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("poap_auth")
}

model QRCode {
  id              String   @id @default(cuid())
  qrHash          String   @unique
  mintLink        String   // Full mint link (e.g., https://poap.xyz/claim/abc123)
  secret          String?  // Secret from POAP API (if retrieved)
  claimed         Boolean  @default(false)
  reservedFor     String?  // twitterId
  reservedAt      DateTime?
  claimedBy       String?  // Ethereum address or email
  claimedAt       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([claimed])
  @@index([reservedFor])
  @@map("qr_codes")
}

model CronLog {
  id              String   @id @default(cuid())
  status          String   // 'success', 'error', 'warning'
  tweetsFound     Int      @default(0)
  processed       Int      @default(0)
  failed          Int      @default(0)
  errorMessage    String?  @db.Text
  errorDetails    String?  @db.Text // JSON with detailed errors
  executionTime   Int?     // Duration in milliseconds
  startedAt       DateTime @default(now())
  completedAt     DateTime?

  @@index([status])
  @@index([startedAt])
  @@map("cron_logs")
}
