datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Config {
  id              String   @id @default(cuid())
  poapEventId     String
  poapSecretCode  String
  botReplyText    String   @default("¡Felicidades! Reclama tu POAP aquí: {{claimUrl}}")
  twitterHashtag  String   @default("#POAP")
  requiredCode    String   @default("ELIGIBLE")

  // POAP API credentials (encrypted)
  poapClientId    String?
  poapClientSecret String?

  // Relación con cuenta del bot
  botAccountId    String?  @unique
  botAccount      BotAccount? @relation(fields: [botAccountId], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("config")
}

model BotAccount {
  id              String   @id @default(cuid())
  twitterId       String   @unique
  username        String
  displayName     String?
  profileImageUrl String?

  // OAuth credentials para postear (encrypted)
  accessToken     String
  accessSecret    String

  // Estado de conexión
  isConnected     Boolean  @default(true)
  lastUsedAt      DateTime?
  connectedAt     DateTime @default(now())

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  config          Config?

  @@map("bot_accounts")
}

model TwitterUser {
  id              String   @id @default(cuid())
  twitterId       String   @unique
  username        String
  displayName     String?
  profileImageUrl String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  deliveries      Delivery[]

  @@map("twitter_users")
}

model Delivery {
  id              String   @id @default(cuid())
  twitterUserId   String
  twitterUser     TwitterUser @relation(fields: [twitterUserId], references: [id])
  tweetId         String   @unique
  mintLink        String
  qrHash          String   @unique
  deliveredAt     DateTime @default(now())
  claimed         Boolean  @default(false)
  claimedAt       DateTime?

  @@index([twitterUserId])
  @@index([claimed])
  @@map("deliveries")
}

model Tweet {
  id              String   @id @default(cuid())
  tweetId         String   @unique
  twitterUserId   String
  username        String
  text            String
  hasImage        Boolean
  hasCode         Boolean
  isEligible      Boolean
  processedAt     DateTime @default(now())
  botReplied      Boolean  @default(false)
  botReplyTweetId String?

  @@index([tweetId])
  @@index([isEligible])
  @@map("tweets")
}

model PoapAuth {
  id              String   @id @default(cuid())
  accessToken     String   @db.Text // OAuth2 bearer token
  expiresAt       DateTime // Token expires after 24h
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("poap_auth")
}

model QRCode {
  id              String   @id @default(cuid())
  qrHash          String   @unique
  mintLink        String   // Full mint link (e.g., https://poap.xyz/claim/abc123)
  secret          String?  // Secret from POAP API (if retrieved)
  claimed         Boolean  @default(false)
  reservedFor     String?  // twitterId
  reservedAt      DateTime?
  claimedBy       String?  // Ethereum address or email
  claimedAt       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([claimed])
  @@index([reservedFor])
  @@map("qr_codes")
}
