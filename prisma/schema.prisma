datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Project {
  id              String   @id @default(cuid())
  name            String   // POAP event name
  poapEventId     String
  poapEditCode    String   // Edit code for POAP API to load QR codes

  // Multiple claims configuration
  allowMultipleClaims Boolean  @default(false)
  requireUniqueCode   Boolean  @default(true)  // If false, POAP delivered without code validation
  requireImage        Boolean  @default(true)  // If false, POAP delivered without image requirement

  // Reply messages
  botReplyEligible    String   @default("¡Felicidades! Has compartido el código correcto. Reclama tu POAP aquí: {{claimUrl}}")
  botReplyNotEligible String   @default("Gracias por tu interés. Asegúrate de incluir un código válido y una imagen en tu tweet.")
  botReplyAlreadyClaimed String @default("You have already claimed a POAP for this event. Only one claim per user is allowed.")

  // Search configuration
  twitterHashtag  String   @default("#POAP")

  // QR Page configuration
  qrPageTweetTemplate String @default("I visited the POAP Studio booth at ETH Global, and here's the proof! The secret word is {{code}} {{hashtag}} {{bot}}")

  // Status
  isActive        Boolean  @default(true)

  // Relations
  validCodes      ValidCode[]
  qrCodes         QRCode[]
  deliveries      Delivery[]
  tweets          Tweet[]
  botAccountId    String?
  botAccount      BotAccount? @relation(fields: [botAccountId], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isActive])
  @@map("projects")
}

// Global config (for POAP API credentials shared across projects)
model Config {
  id              String   @id @default(cuid())

  // POAP API credentials (encrypted) - shared across all projects
  poapClientId    String?
  poapClientSecret String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("config")
}

model ValidCode {
  id              String   @id @default(cuid())
  code            String   @unique  // UNIQUE globally - each code identifies ONE project
  projectId       String
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  isScanned       Boolean  @default(false)   // True when QR is scanned (user visits tracking page)
  scannedAt       DateTime?                 // When the QR was first scanned
  isUsed          Boolean  @default(false)   // True when code is detected in valid tweet
  usedBy          String?                   // twitterId of user who tweeted with this code
  usedAt          DateTime?                 // When the code was used in a tweet
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isUsed])
  @@index([isScanned])
  @@index([projectId])
  @@map("valid_codes")
}

model BotAccount {
  id              String   @id @default(cuid())
  twitterId       String   @unique
  username        String
  displayName     String?
  profileImageUrl String?

  // OAuth credentials para postear (encrypted)
  accessToken     String
  accessSecret    String

  // Webhook configuration
  webhookId       String?  // Twitter webhook ID for this bot account

  // Estado de conexión
  isConnected     Boolean  @default(true)
  lastUsedAt      DateTime?
  connectedAt     DateTime @default(now())

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  projects        Project[]

  @@map("bot_accounts")
}

model TwitterUser {
  id              String   @id @default(cuid())
  twitterId       String   @unique
  username        String
  displayName     String?
  profileImageUrl String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  deliveries      Delivery[]

  @@map("twitter_users")
}

model Delivery {
  id              String   @id @default(cuid())
  projectId       String
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  twitterUserId   String
  twitterUser     TwitterUser @relation(fields: [twitterUserId], references: [id])
  tweetId         String
  mintLink        String
  qrHash          String
  deliveredAt     DateTime @default(now())
  claimed         Boolean  @default(false)
  claimedAt       DateTime?

  @@unique([tweetId, projectId])
  @@unique([qrHash, projectId])
  @@index([twitterUserId])
  @@index([claimed])
  @@index([projectId])
  @@map("deliveries")
}

model Tweet {
  id              String   @id @default(cuid())
  projectId       String
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tweetId         String
  twitterUserId   String
  username        String
  text            String
  hasImage        Boolean
  hasCode         Boolean
  isEligible      Boolean
  processedAt     DateTime @default(now())
  botReplied      Boolean  @default(false)
  botReplyTweetId String?

  @@unique([tweetId, projectId])
  @@index([tweetId])
  @@index([isEligible])
  @@index([projectId])
  @@map("tweets")
}

model PoapAuth {
  id              String   @id @default(cuid())
  accessToken     String   @db.Text // OAuth2 bearer token
  expiresAt       DateTime // Token expires after 24h
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("poap_auth")
}

model QRCode {
  id              String   @id @default(cuid())
  projectId       String
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  qrHash          String
  mintLink        String   // Full mint link (e.g., https://poap.xyz/claim/abc123)
  secret          String?  // Secret from POAP API (if retrieved)
  claimed         Boolean  @default(false)
  reservedFor     String?  // twitterId
  reservedAt      DateTime?
  claimedBy       String?  // Ethereum address or email
  claimedAt       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([qrHash, projectId])
  @@index([claimed])
  @@index([reservedFor])
  @@index([projectId])
  @@map("qr_codes")
}

model CronLog {
  id              String   @id @default(cuid())
  status          String   // 'success', 'error', 'warning'
  tweetsFound     Int      @default(0)
  processed       Int      @default(0)
  failed          Int      @default(0)
  errorMessage    String?  @db.Text
  errorDetails    String?  @db.Text // JSON with detailed errors
  executionTime   Int?     // Duration in milliseconds
  startedAt       DateTime @default(now())
  completedAt     DateTime?

  @@index([status])
  @@index([startedAt])
  @@map("cron_logs")
}

// Twitter Webhook Events - Temporary storage for analysis
model TwitterWebhookEvent {
  id              String   @id @default(cuid())
  method          String   // GET or POST
  path            String   // Request path
  headers         Json     // All request headers
  queryParams     Json?    // Query parameters (for CRC)
  body            Json?    // Request body (for events)
  ipAddress       String?  // Source IP
  userAgent       String?  // User agent
  eventType       String?  // Parsed event type if available
  receivedAt      DateTime @default(now())

  @@index([method])
  @@index([eventType])
  @@index([receivedAt])
  @@map("twitter_webhook_events")
}
